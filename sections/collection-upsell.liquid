{% comment %}
  Collection with Upsell Modal — Horizon-integrated (v11)
  - Metafield: product.metafields.custom.upsell_products (Product → List → Product)
  - JS asset required: assets/collection-upsell.js
{% endcomment %}

{% liquid
  assign col                = section.settings.collection
  assign heading            = section.settings.heading
  assign modal_heading      = section.settings.modal_heading | default: 'Complete your look'
  assign refresh_sections   = section.settings.refresh_sections | default: 'cart-drawer,cart-icon-bubble'
  assign cart_open_selector = section.settings.cart_open_selector  | default: '.cart-drawer, [data-cart-drawer], [id*="CartDrawer"]'
  assign pt                 = section.settings.padding_top   | default: 40
  assign pb                 = section.settings.padding_bottom| default: 40
%}

<section
  id="collection-upsell-{{ section.id }}"
  class="collection-upsell"
  style="padding-top:{{ pt }}px; padding-bottom:{{ pb }}px;"
  data-refresh-sections="{{ refresh_sections | escape }}"
  data-cart-open-selector="{{ cart_open_selector | escape }}"
  data-modal-heading="{{ modal_heading | escape }}"
>
  <div class="page-width">
    {% if heading != blank %}
      <h2 class="collection-upsell__heading">{{ heading | escape }}</h2>
    {% endif %}

    {% if col != blank %}
      <div class="collection-upsell__grid">
        {% for product in col.products %}
          {% liquid
            assign current_variant = product.selected_or_first_available_variant
            assign sku   = current_variant.sku | default: product.variants.first.sku
            assign image = product.featured_image
            assign upsell_list = product.metafields.custom.upsell_products.value
          %}
          <article class="product-card" data-product-handle="{{ product.handle }}">
            <a href="{{ product.url }}" class="product-card__media" aria-label="{{ product.title }}">
              {% if image %}
                <img loading="lazy" src="{{ image | image_url: width: 700 }}" alt="{{ image.alt | escape }}">
              {% endif %}
            </a>

            <h3 class="product-card__title">{{ product.title }}</h3>
            <div class="product-card__sku">SKU: {{ sku | default: '—' }}</div>

            <button
              class="button button--primary open-upsell-modal"
              type="button"
              data-open-modal
              data-product-handle="{{ product.handle }}"
              data-variant-id="{{ current_variant.id }}"
            >
              Add to cart
            </button>

            <!-- JSON payload consumed by collection-upsell.js -->
            <script type="application/json" class="product-upsell-data">
            {
              "title": {{ product.title | json }},
              "imageUrl": {{ image | image_url: width: 700 | json }},
              "variantId": {{ current_variant.id | json }},
              "variantPrice": {{ current_variant.price | json }},
              "sku": {{ sku | json }},
              "upsells": [
                {%- for up in upsell_list -%}
                  {%- assign up_var = up.selected_or_first_available_variant -%}
                  {
                    "productId": {{ up.id | json }},
                    "handle": {{ up.handle | json }},
                    "title": {{ up.title | json }},
                    "variantId": {{ up_var.id | json }},
                    "price": {{ up_var.price | json }},
                    "imageUrl": {{ up.featured_image | image_url: width: 500 | json }},
                    "available": {{ up_var.available | json }}
                  }{%- unless forloop.last -%},{%- endunless -%}
                {%- endfor -%}
              ]
            }
            </script>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p>No collection selected.</p>
    {% endif %}
  </div>

  <!-- Modal (one per section) -->
  <div class="upsell-modal" hidden data-upsell-modal>
    <div class="upsell-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="upsellModalTitle">
      <button class="upsell-modal__close" type="button" data-modal-close aria-label="Close">×</button>

      <div class="upsell-modal__content">
        <!-- LEFT column -->
        <div class="upsell-modal__left">
          <p class="upsell-modal__eyebrow" data-eyebrow>{{ modal_heading | escape }}</p>
          <div class="upsell-modal__product" data-base-product></div>
        </div>

        <!-- RIGHT column -->
        <div class="upsell-modal__right">
          <div class="upsell-modal__carousel" data-upsell-carousel></div>
        </div>

        <!-- FOOTER (spans both) -->
        <div class="upsell-modal__footer">
          <div class="upsell-modal__subtotal">Subtotal: <span data-subtotal></span></div>
          <button class="button button--primary" type="button" data-confirm-add>Confirm add to cart</button>
        </div>
      </div>
    </div>
    <div class="upsell-modal__backdrop" data-modal-close></div>
  </div>
</section>

{% schema %}
{
  "name": "CollectionwithUpsellModal",
  "settings": [
    { "type": "collection", "id": "collection", "label": "Collection" },
    { "type": "text", "id": "heading", "label": "Section heading", "default": "Bestsellers" },
    { "type": "text", "id": "modal_heading", "label": "Modal heading", "default": "Complete your look" },

    { "type": "range", "id": "padding_top", "min": 0, "max": 120, "step": 4, "unit": "px", "label": "Padding top", "default": 40 },
    { "type": "range", "id": "padding_bottom", "min": 0, "max": 120, "step": 4, "unit": "px", "label": "Padding bottom", "default": 40 },

    { "type": "text", "id": "refresh_sections", "label": "Cart sections to refresh (comma-separated IDs)", "default": "cart-drawer,cart-icon-bubble" },
    { "type": "text", "id": "cart_open_selector", "label": "Cart drawer selector(s)", "default": ".cart-drawer, [data-cart-drawer], [id*=\"CartDrawer\"]" }
  ],
  "presets": [{ "name": "Collection with Upsell Modal" }]
}
{% endschema %}


{{ 'collection-upsell.js' | asset_url | script_tag }}
{{ 'collection-upsell.css' | asset_url | stylesheet_tag }}

